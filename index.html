<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Большая Первомайская викторина от Суши Мастер</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script> 
    <link rel="stylesheet" href="main.css" />
    <script src="questions.js"></script>    
</head>
<body>

<audio loop id="audioMain">
    <source src="music/main-asia.mp3" type="audio/mpeg">    
    Проигрывание музыки не поддерживается.
</audio>

<audio loop id="audioWin">
    <source src="music/win.mp3" type="audio/mpeg">    
    Проигрывание музыки не поддерживается.
</audio>

<div id = "start-screen-id" class="start-screen">
    <div>
        <div class="image-start-screen">            
            <img src="pic/rules_cat.png" alt="start_screen_cat_pic">
        </div>       
        <div class="title_28_black">
            <p>Приготовься к интеллектуальному пикнику!</p>
        </div>        
        <div class="start-screen-body">
            <p>Большая Первомайская викторина от Суши Мастер – это настоящий майский марафон знаний.</p>
        </div>
        <div class="modal-footer" style="margin-top: 20px;">            
            <button id="show-rules" class="button-common button-common-rules">Читать правила</button>      
        </div>                
        <div class="modal-footer" style="margin-top: 20px;">            
            <button id="start-game" class="button-common">Начать игру</button>      
        </div>
    </div>   
</div>

<div id = "rules-screen-id" class="rules-screen">
    <div>
        <div class="title_28_black">
            <p>Правила игры</p>
        </div>        
        <div class="image-rules-screen">            
            <img src="pic/little_cat_rules.png" alt="rules_screen_cat_pic">
        </div>               
        <div class="rules-screen-body">
            <p>Игрок должен ответить на вопросы о весне, труде, шашлыках, пикниках и прочих радостях Первомая. За каждый правильный ответ – бонусные баллы в копилку. Но это еще не всё! После 4 и 8 вопросов игрока ждёт «несгораемая сумма» – можно забрать заработанное и гордо уйти, или рискнуть и дойти до конца викторины. Везунчик, который верно ответит на 10 вопрос, станет обладателем главного приза – 300 бонусных баллов от Суши Мастер!</p>
        </div>        
        <div class="modal-footer" style="margin-top: 20px;">            
            <button id="start-game2" class="button-common">Начать игру</button>      
        </div>
    </div>   
</div>

<div id = "main_questions_screen_id" class="main_questions_screen">
    <div>
        <div class="ved_timer">
            <div class="image-main-screen-cat">            
                <img src="pic/ved_cat.png" alt="ved_screen_cat_pic">
            </div>
            <div class="timer-image">
                <div class="timer-text" id="timer">0</div>
            </div>           
        </div>
        
        <div id="question-text-id" class="main-screen-body">
            <p>Какой вид картошки?</p>
        </div>        
        
        <div class="hints">
            <button class="btn-main-screen-hint" data-hint="5050">
                <img src="pic/50.png" alt="50_50_pic">
            </button>
            <button class="btn-main-screen-hint" data-hint="friend">
                <img src="pic/sushi_master.png" alt="sushi_pic">
            </button>
            <button id="show-results" class="btn-main-screen-option">
                <img src="pic/show_results.png" alt="show_result_pic">
            </button>
            <button id="music-off" class="btn-main-screen-option">
                <img src="pic/sound_pic.png" alt="turn_sound_pic">
            </button>                                                
        </div>
        
        <div class="game">                        
            <div class="question-container">                
                <div class="answers"></div>
            </div>
           
            <p class="result"></p>
        </div>                 
    </div>
</div>

<div id="сongratulations-dialogue" class="modal-dialog">
    <div class="modal-content">
        <div class="modal-image">            
            <img id="modal-image-pic" src="pic/level1_prize_cat.png" alt="modal_image_pic">
        </div> 
        <div id="modal-header-id" class="modal-title">
            <p>Поздравлем!</p>
        </div>
        <div id='modal-text' class="modal-body">
            <p> Ты достиг первой несгораемой суммы баллов! Хочешь продолжить игру и испытать удачу или желаешь забрать свой приз?</p>
        </div>
        <div id = "modal-footer-bronze-silver" class="modal-footer">
            <button type="button" id="btn-modal-dialog-take-prize-bronze-silver" class="btn-modal-dialog-take-prize">
                <img src="pic/gift.png" alt="Icon" class="icon" style="width: 40px; height: 40px;">
                <div class="btn-modal-dialog-take-prize-text">Приз</div>
            </button>           
            <button id="continue-game-btn" class="btn-modal-dialog-continue">Продолжить</button>
        </div>
        <div class="modal-footer-gold hidden">
            <button type="button" id="btn-modal-dialog-take-prize-gold" class="btn-modal-dialog-take-prize-gold">
                <img src="pic/gift.png" alt="Icon" class="icon" style="width: 40px; height: 40px;">
                <div class="btn-modal-dialog-take-prize-text">Забрать главный приз</div>
            </button>                       
        </div>
        
    </div>
</div>

<div id="mistersuhint" class="mistersu-dialog">
    <div>
        <div class="modal-image">            
            <img src="pic/mister_су_pic.png" alt="mister_су_pic">
        </div>       
        <div class="modal-title">
            <p>ПОДСКАЗКА МАСТЕРА СУ</p>
        </div>        
        <div id="mistersu-hint-text" class="modal-body">
            <p>Текст подсказки</p>
        </div>
        <!-- <div id="palki" class="modal-palki">
            <img src="pic/palki.png" alt="palki_pic">
        </div>    -->
        <div class="modal-footer">            
            <button id="return-game-button" class="btn-modal-dialog">Вернуться к игре</button>            
        </div>
    </div>
</div>

<div id="losegame" class="lose-game-dialog">
    <div>
        <div class="modal-image-lose">            
            <img src="pic/lose_cat_2.png" alt="lose_game_cat2_pic">
        </div>       
        <div class="title_28_black">
            <p>Эх, бывает</p>
        </div>        
        <div class="modal-body">
            <p>Сегодня знания немного подвели. Но не сдавайся! Завтра – реванш.</p>
        </div>        
        <div class="modal-palki">            
            <img src="pic/riba.png" alt="riba_pic">
        </div>     
        <div class="modal-footer">            
            <button id="exit-game-lose" class="btn-modal-lose-game-dialog">Попробовать завтра</button>            
        </div>
    </div>
</div>

<script>

let currentQuestionIndex = 0;
let hintsUsed = [];
let totalPrize = 0;
let isMusicPlay = true;

let prizeDiscounteLevel = "0";
const goldLevel = "GOLD";
const silverLevel = "SILVER";
const bronzeLevel = "BRONZE";




let timerInterval = null;
const SECONDS_FOR_ONE_QUESTION = 30;
let audioMain = document.getElementById("audioMain");
let audioWin = document.getElementById("audioWin");

document.getElementById('start-game').addEventListener('click', startGame);
document.getElementById('start-game2').addEventListener('click', startGame);
document.getElementById('show-rules').addEventListener('click', showRules);
document.getElementById('show-results').addEventListener('click', showResultScreen);
document.getElementById('music-off').addEventListener('click', switchMusic);


document.getElementById('timer').textContent = SECONDS_FOR_ONE_QUESTION;
document.getElementById("continue-game-btn").addEventListener("click", function () {
    hideDialog(); // Скрыть диалог
    continueGame(); // Продолжение игры
});
document.getElementById("btn-modal-dialog-take-prize-bronze-silver").addEventListener("click", function () {
    hideDialog(); // Скрыть диалог
    claimPrize(); // Забирание приза
});
document.getElementById("btn-modal-dialog-take-prize-gold").addEventListener("click", function () {
    hideDialog(); // Скрыть диалог
    claimPrize(); // Забирание приза
});
document.getElementById("return-game-button").addEventListener("click", continueGame);

document.getElementById("exit-game-lose").addEventListener("click", function () {
    //тут нужно закрывать игру с призом NONE
    hideDialog()
});

document.querySelectorAll('.btn-main-screen-hint').forEach(button => {
        button.addEventListener('click', () => useHint(button.dataset.hint));
    });
       
    function startGame() {
        document.getElementById("main_questions_screen_id").style.display = "block";
        document.getElementById('start-screen-id').style.display = "none";
        document.getElementById('rules-screen-id').style.display = "none";                
        audioMain.volume = 0.2;
        audioWin.volume = 0.2;
        audioMain.play();       
        nextQuestion();
    }

    function showRules() {
        document.getElementById("rules-screen-id").style.display = "block";
        document.getElementById('start-screen-id').style.display = "none";        
        audioMain.volume = 0.2;
        audioWin.volume = 0.2;
        audioMain.play();               
    }

    
    function startTimer() {
        let timeLeft = SECONDS_FOR_ONE_QUESTION;                
            if (!timerInterval) {
                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        document.getElementById('timer').innerText = timeLeft;                        
                    } else {
                        resetTimerForNextQuestion()
                        showFinalScreen(false)                        
                    }
                }, 1000);
            }            
        }
    function resetTimerForNextQuestion() {        
        document.getElementById('timer').innerText = SECONDS_FOR_ONE_QUESTION;
        clearInterval(timerInterval);
        timerInterval = null
    }    


    function nextQuestion() {        
        
        //document.getElementById('current-question-text').textContent = 'Номер вопроса: '+ (currentQuestionIndex+1);        
        resetTimerForNextQuestion();  
        
        switch (currentQuestionIndex) {
            case 4:
                showModalDialog(bronzeLevel);                
                break;           
            case 8:                
                showModalDialog(silverLevel);
                break;             
        }

        if (currentQuestionIndex >= questions.length) {            
            showFinalScreen(true);
            return;
        }

        startTimer()
        

        const question = questions[currentQuestionIndex];
        document.getElementById('question-text-id').textContent = question.question;
        //document.querySelector('.question').textContent = question.question;
        document.querySelector('.answers').innerHTML = '';

        question.answers.forEach(answer => {
            const button = document.createElement('button');
            button.className = 'answer-button';
            button.textContent = answer;
            button.addEventListener('click', () => checkAnswer(answer));
            document.querySelector('.answers').appendChild(button);
        });

        document.querySelector('.result').textContent = '';
    }

    function checkAnswer(answer) {
        const question = questions[currentQuestionIndex];
        if (answer === question.correctAnswer) {
            document.querySelector('.result').textContent = 'Правильно!';
            document.querySelector('.result').style.color = 'green';
            totalPrize += question.prize;
            currentQuestionIndex++;
            setTimeout(nextQuestion, 1000);
        } else {
            document.querySelector('.result').textContent = 'Неправильно! Игра окончена.';
            document.querySelector('.result').style.color = 'red';
            showFinalScreen(false);
        }
    }

    function useHint(hintType) {
        if (hintsUsed.includes(hintType)) return;
        hintsUsed.push(hintType);
        
        const hintButtons = document.querySelectorAll('.btn-main-screen-hint');
        for (let i = 0; i < hintButtons.length; i++) {
            if (hintButtons[i].dataset.hint === hintType) {
                    hintButtons[i].classList.add('disabled');                    
                    break;                                 
            }
        }

        switch (hintType) {
            case 'friend':
                showMisterSuHint();                
                break;           
            case '5050':
                removeTwoWrongAnswers();
                break;            
        }
    }

    function removeTwoWrongAnswers() {
        const question = questions[currentQuestionIndex];
        const wrongAnswers = question.answers.filter(answer => answer !== question.correctAnswer);
        const randomIndexes = Array.from({length: wrongAnswers.length}, (_, i) => i).sort(() => Math.random() - 0.5).slice(0, 2);

        wrongAnswers.forEach((wrongAnswer, index) => {
            if (randomIndexes.includes(index)) {
                const buttons = document.querySelectorAll('.answer-button');
                buttons.forEach(button => {
                    if (button.textContent === wrongAnswer) {
                        button.style.display = 'none';
                        //button.style.opacity = 0.5;
                    }
                });
            }
        });
    }

    function showResultScreen() {

    }

    function switchMusic() {
        
        if(isMusicPlay) {
            audioMain.pause();
            isMusicPlay = false;
            document.getElementById('music-off').classList.add('btn-main-screen-option-active');            
        } else {
            audioMain.play();
            isMusicPlay = true;
            document.getElementById('music-off').classList.remove('btn-main-screen-option-active');            
        }        
    }

    function showFinalScreen(isWin) {
        audioMain.pause()                        
        if(isWin) {            
            audioWin.play()
            showModalDialog(goldLevel);
        } else {   
            document.getElementById("losegame").style.display = "block";          
        }         
    }

    // Показ модального окна
    function showModalDialog(level) {

        let textHeaderElement = document.getElementById('modal-header-id');
        let modalTextElement = document.getElementById('modal-text');
        let modalImage = document.getElementById('modal-image-pic');
        document.getElementById("main_questions_screen_id").style.display = "none";
        document.getElementById("сongratulations-dialogue").style.display = "block";

        switch (level) {
            case bronzeLevel:
            textHeaderElement.textContent = 'Поздравляем!';
            modalTextElement.textContent = 'Ты достиг первой несгораемой суммы баллов! Хочешь продолжить игру и испытать удачу или желаешь забрать свой приз?';
            modalImage.src = 'pic/level1_prize_cat.png';  
            prizeDiscounteLevel = bronzeLevel;              
                break;           
            case silverLevel:            
            textHeaderElement.textContent = 'Вау!';
            modalTextElement.textContent = 'Вторая несгораемая сумма – это круто! Но игра еще не окончена. Продолжаешь бороться за главный приз или заберешь награду?';                
            modalImage.src = 'pic/level2_prize_cat.png';
            prizeDiscounteLevel = silverLevel;              
                break;
            case goldLevel:                            
            document.getElementById('modal-footer-bronze-silver').style.display = 'none';
            document.querySelector('.modal-footer-gold').classList.remove('hidden');

            textHeaderElement.textContent = 'Победа!';
            modalTextElement.textContent = 'Ты ответил на все вопросы и выиграл 300 баллов! Перед тобой преклоняются все гуру пикников, повелители дач и грозы субботников ;)';
            modalImage.src = 'pic/level3_prize_cat.png';                    
            prizeDiscounteLevel = goldLevel;              
                break;    
        }

       
    }

    //Показ подсказки места Су
function showMisterSuHint() {
    let quetionsVariant = getCurrentQuestionListForMisterSu();
    let randomHintText = quetionsVariant[Math.floor(Math.random() * quetionsVariant.length)];
    document.getElementById("main_questions_screen_id").style.display = "none";
    document.getElementById("mistersuhint").style.display = "block";
    document.getElementById('mistersu-hint-text').textContent = randomHintText;
}

function getCurrentQuestionListForMisterSu() {
    let correctAnswer = questions[currentQuestionIndex].correctAnswer

    return friendHints = [
    'Хм... Интересный вопрос. Мой внутренний компас указывает на ' + correctAnswer + ', но... вдруг это ловушка? В общем, решай сам, я лишь скромный наблюдатель за звёздным небом.',
    'Вероятнее всего, ответ – ' + correctAnswer + '. Но я бы на твоём месте перепроверил всё трижды, а потом ещё раз. На всякий случай. Просто на всякий.',
    'По моим расчётам (которые, конечно, могут быть слегка неточными), правильный ответ – ' + correctAnswer + '. Но... я бы не стал на этом слишком настаивать. Вдруг это всё заговор?',
    'Интуиция подсказывает мне ' + correctAnswer + ', но интуиция – штука капризная. Вон, вчера она мне сказала, что дождь будет – а он, видите ли, не пошёл! Задумайся над этим…',
    'Я вижу... я вижу... Ага! Ответ – ' + correctAnswer + '. Почти наверняка. Но... есть небольшое, совсем крошечное, едва уловимое сомнение...',
    'Мой магический хрустальный шар (ну, обычный стеклянный, но звучит так круче) показывает ' + correctAnswer + '. Однако, этот шар сегодня немного мутноват. Может, его протереть? Или всё-таки рискнуть?',
    'Согласно древним свиткам (ну, на самом деле, я это в Википедии прочитал), правильный ответ – ' + correctAnswer + '. Однако, древние свитки часто ошибаются.',
    'Звёзды намекают на ответ – ' + correctAnswer + ', но я подозреваю, что это всего лишь планетарное выравнивание, которое не имеет отношения к викторине. Или имеет? Загадка!',
    'Инстинкты кричат "' + correctAnswer + '", но мои инстинкты часто ведут меня к холодильнику, а не к вершинам интеллекта. Сделай выводы.',
    'Согласно моей тщательно разработанной системе (написанной на салфетке), ответ – ' + correctAnswer + '. Но салфетка немного заляпана соусом терияки. Случайность? Не думаю...',
    'Логика подсказывает ' + correctAnswer + ', но логика – сухая наука. А жизнь прекрасна и многогранна. Как и выбор вариантов ответов.'
];
} 

// Скрытие модального окна
    function hideDialog() {
    document.getElementById('сongratulations-dialogue').style.display = "none";
    document.getElementById('mistersuhint').style.display = "none";
    document.getElementById('losegame').style.display = "none";
    document.getElementById("main_questions_screen_id").style.display = "block";
    }

// Функция продолжения игры
    function continueGame() {
        hideDialog(); // Скрыть диалог                   
    }

// Функция забрания приза
    function claimPrize() {
    console.log("Приз получен!");
    showFinalScreen(true)
    // Здесь добавляется логика получения приза
    }   
   
</script>

<script>
    let tg = window.Telegram.WebApp; //получаем объект webapp телеграма 
    tg.expand(); //расширяем на все окно   
    
    document.getElementById('btn-modal-dialog-take-prize-bronze-silver').addEventListener('click', function(){ //вешаем событие на нажатие html-кнопки
        tg.sendData(prizeDiscounteLevel);      
    });   

    document.getElementById('btn-modal-dialog-take-prize-gold').addEventListener('click', function(){ //вешаем событие на нажатие html-кнопки
       tg.sendData(prizeDiscounteLevel);      
       
    });  
 </script>
</body>
</html>